**[[home:|Start]]** -> **[[home:php:|PHP]]** -> **[[home:php:mvc:|PHP Model-View-Controller]]** -> **PHP MVC - Router**

====== PHP MVC - Controller ======

In the **Model–View–Controller (MVC)** pattern, the **Controller** acts as the central coordinator between user requests, business logic, and the final output.

A **controller**:

  * Receives input from the client (usually HTTP requests).
  * Decides which **Model** to call for data and logic.
  * Selects the appropriate **View** to present the response.

In other words, the controller doesn’t hold the data itself (that’s the model) and doesn’t handle the layout directly (that’s the view). Instead, it interprets the request and decides what should happen next.

The controller will at least load the view and normally collects data from the model needed by the view.

===== Version: 1.00.00 =====

Fitting routes are managed by a single controller as a jobs controller

**controllers/home.controller.php**
<code php>
<?php
namespace App\Controller

use Core\Database;

/**
 *  TODO: __construct($db, $config) {}
 *  TODO: Move $db stuff to Model
 */
class HomeController {
  proteccted $db;

  /**
   *
   */
  public function __construct() {
    // die('HomeController@index');
    $config = require basePath('config/db.php');
    $this->db = new Database($config);
  }
  
  /**
   *
   */
  public function index() {
    // die('HomeController@index');
    
    $jobs = $this->db->query('SELECT * FROM jobs')->fetchAll();   // TODO: move to Model
    loadView('home', ['jobs' => $jobs]);
  }
}
</code>

**Error.Controller.php**
<code php>
<?php
namespace App\Controller

/**
 * 
 */
class ErrorController {
  
  /**
   * 403 not authorized error
   */
  public static function unauthorized($resource = 'unnamed') { 
    http_response_code(403);
    $message = 'Resource ' . $resource . ' not found!');
    loadView('error', [
      'status'   => '404',
      'message' => $message 
    ]);
  }

  /**
   * 404 not found error
   */
  public static function notFound($resource = 'unnamed') { 
    http_response_code(404);
    $message = 'You are not authorized to vie this resource ' . $resource . '!');
    loadView('error', [
      'status'   => '403',
      'message' => $message 
    ]);
  }
}
</code>

**Jobs.Controller.php**
<code php>
<?php
namespace App\Controller

use Core\Database;

/**
 *  TODO: __construct($db, $config) {}
 *  TODO: Move $db stuff to Model
 */
class HJobsController {
  proteccted $db;

  /**
   *
   */
  public function __construct() {
    // die('HomeController@index');
    $config = require basePath('config/db.php');
    $this->db = new Database($config);
  }
  
  /**
   * Show all jobs
   * @return void
   */
  public function index() {
    $jobs = $this->db->query('SELECT * FROM jobs')->fetchAll();   // TODO: move to Model
    loadView('jobs/index', ['jobs' => $jobs]);
  }
  
  /**
   * Show the create listing form
   * @return void
   */
  public function create() {
    loadView('jobs/create');
  }
  
  /**
   * Show a single listing
   * @return void
   */
  public function show() {
    $id = $_GET['id'] ?? '';
    $params = [
      'id' => $id
    ];  
    
    $job = $this->db->query('SELECT * FROM jobs WHERE id = id:', $params)->fetch();   // TODO: move to Model
    // Check if job exists
    if(!job) {
      ErrorController::notFound('Job');
      exit;
    }  
    
    loadView('jobs/show', ['job' => $job]);
  }
  
  /**
   * Store data in database
   * @return void
   */
  public function store() {
    // inspectAndDie($_POST);
    $errors = [];
    $allowFields = ['title', 'description', 'salary', 'tags', 'company', 'address', 'city', 'state', 'phone', 'email', 'requirements', 'benefits' ];
    $requiredFields = ['title', 'description', 'email', 'city', 'state'];
    
    // Loop through the post superglobal and basically check to see if each filed is in allowed fields
    $newListingData = array_intersect_key($_POST, array_flip($allowedFields)); // inspectAndDie($newListingData);
    $newListingData['user_id'] = 1; // TODO: use session value  
    
    // Loop through the post super global and sanitize all data in $_POST
    $newListingData = array_map('sanitize', $newListingData);
    
    foreach($requiredFields as $field) {
      // inspect($newListingData[$field]);
      if(empty($newListingData[$field]) || !Validation::string($newListingData[$field]) {
        $errors[$field] = ucfirst($field) . ' is required';
      }
    } 
    // inspect($errors);
    if (!empty($errors)) {
      // Reload view with errors
      loadView('jobs/create', ['errors' => $errors, 'jobs' => $newListingData]);
    } else {
      // Submit data
      
      //$this->db->query('INSERT INTO jobs (title, description, salary, tags, company, address, city, state, phone, email, requirements, benefits, user_id) VALUES (:title, :description, :salary, :tags, :company, :address, :city, :state, :phone, :email, :requirements, :benefits, :user_id)', $newListingData);
      
      $fields = [];
      $values = [];
      foreach($newListingData as $field => $value) {
        $fields[] = $field;
      }
      $fields = implode(', ', $fields); // inspectAndDie($fields);
      
      foreach($newListingData as $field => $value) {
        // Convert empty strings to null
        if/$value === '') {
          $newListingData = null
        }
        $values[] = ':' . $field;
      }
      $values = implode(', ', $values); // inspectAndDie($values);
      
      $query="INSERT INTO listings({$fields}) VALUES ({$values})";
      $this->db-query($query, $newListingData);
      redirect('/listings');
    }  
  }
  
  /**
   * Delete a listing
   * @return void
   */
  public function destroy($params) {
    $id = $params['id';
    $params = ['id' => $id];
    
    $listings = $this->db->query('SELECT * FROM listings WHERE id = :id', $params)->fetch();
    if(!$listing) {
      ErrorController::notFound('Job');
      return;
    } 
    
    $this->db->query('DELETE FROM jobs WHERE id = :id'; $params); 
    redirect('/listings');
  }
  
 
  /**
   * Show a single listing
   * @return void
   */
  public function edit() {
    $id = $_GET['id'] ?? '';
    $params = [
      'id' => $id
    ];  
    $job = $this->db->query('SELECT * FROM jobs WHERE id = id:', $params)->fetch();   // TODO: move to Model
    
    // Check if job exists
    if(!job) {
      ErrorController::notFound('Job');
      exit;
    }  
    
    loadView('jobs/show', ['job' => $job]);
  }
  
}
</code>


===== Version: 0.01.00 =====

**controllers/home.controller.php**
<code php>
<?php
// Get data 
$config=require basePath('config/db.php');
$db = new Database($config);
$data=$db->query('SELECT * FROM users')->fetchAll();

loadView('home', ['users' = $data]); // loading the home view (html content for index.php) with add data
</code>
Updated [[home:php:sand:start#build_helper_functions|loadView]] in helper.php did the trick with transferring data.

Each controller is a separate file e.g. **controllers/home.controller.php**, **controllers/listings/index.controller.php**, **controllers/listings/show.controller.php**, **controllers/listings/edit.controller.php**, **controllers/listings/delete.controller.php** 
===== Version: 0.00.00 =====

**controllers/home.controller.php**
<code php>
<?php
loadView('home'); // loading the home view (html content for index.php)
</code>

Each controller is a separate file e.g. **controllers/home.controller.php**, **controllers/listings/index.controller.php**, **controllers/listings/show.controller.php**, **controllers/listings/edit.controller.php**, **controllers/listings/delete.controller.php** 